<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full roster</title>
    <link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/navbar.css">
    <style>
    table {
        width: 80%;
        margin: 24px auto;
        border-collapse: collapse;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        border-radius: 8px;
        overflow: hidden;
    }
    th, td {
        padding: 4px 18px;
        text-align: left;
    }
    th {
        background: #f5f6fa;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e1e4ea;
    }
    tr:nth-child(even) {
        background: #f9fafb;
    }
    tr:hover {
        background: #eaf6ff;
    }

    .sort-btn{
        margin-left:6px;
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        vertical-align: middle;
        font-size: 1.2em;
        color: black;
        transition: color 0.2s;
        min-width: 20px;
    }
    .sort-btn:hover {
        background: #e5e7eb;
        color: black;
    }

    .kick{
        background-color: #ff7a7a;
        margin-left: 8px;
        min-width: 0;
    }
    </style>

    <script>
        function kickmember(userId) {
            if (confirm("U sure?")) {
                msg = prompt("(optional) Reason for kicking this member:");
                fetch(`/roster/kick/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: msg })
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert("Something went wrong - failed to kick member :(");
                    }
                });
            }
        }

        function addhours(){
            const selectedEvent = document.getElementById('event-select').value;
            const checkboxes = document.querySelectorAll('input[name="addhours"]:checked');
            const hours = document.getElementById('hours-input').value;
            if (checkboxes.length === 0) {
                alert("Please select at least one member.");
                return;
            }
            const userIds = Array.from(checkboxes).map(cb => cb.value);
            fetch('/roster/addhours', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event_id: selectedEvent, 
                    user_ids: userIds, hours: hours })
            }).then(response => {
                if (response.ok) {
                    alert("Hours added successfully!");
                    window.location.reload();
                } else {
                    alert("Failed to add hours.");
                }
            });
        }
        
    </script>
</head>
<body>
    <h2 style='text-align:center;'>All Members</h2>
    <!-- <div class="container"> -->
        <form onsubmit="addhours()">
            <select id="event-select" required>
                <option disabled selected value="">Pick event:</option>
                {% for ev in events %}
                    <option value="{{ ev.id }}" data-hours="{{ ev.hours|float }}">{{ ev.name }}</option>
                {% endfor %}
            </select>
            <input id="hours-input" type="number" placeholder="Hours" step="0.25" required readonly>
            <button type="submit">Give hours to all selected members</button>
        </form>
    <!-- </div> -->
    <script>
        const eventSelect = document.getElementById('event-select');
        const hoursInput = document.getElementById('hours-input');
        function updateForm() {
            const selected = eventSelect.options[eventSelect.selectedIndex];
            if(selected && selected.dataset.hours == 0) {
                hoursInput.readOnly = false;
                hoursInput.value = '';
            } else if(selected) {
                hoursInput.readOnly = true;
                hoursInput.value = selected.dataset.hours;
            }
        }
        eventSelect.addEventListener('change', updateForm);
    </script>

    <table>
        <tr>
            <th></th>
            <th>First Name 
                <button id="sort-fname-btn" aria-label="Sort by first name" class="sort-btn">⇅</button>
            </th>
            <th>Last Name
                <button id="sort-lname-btn" aria-label="Sort by last name" class="sort-btn">⇅</button>
            </th>
            <th>Student ID</th>
            <th>Role
                <button id="sort-role-btn" aria-label="Sort by role" class="sort-btn">⇅</button>
            </th>
            <th>Status</th>
            <th></th>
        </tr>
        {% for u in users %}
            <tr>
                <td>
                    <input type="checkbox" name="addhours" value="{{u['id']}}"
                    style="transform: scale(1.5)">
                </td>
                <td>{{ u['fname'] }}</td>
                <td>{{ u['lname'] }}</td>
                <td>{{ u['sid'] }}</td>
                <td>{{ u['role'] }}</td>
                <td>{{ u['status'] }}</td>
                <td><button class="kick" onclick="kickmember( {{u['id']}} )">remove</button></td>
            </tr>
        {% endfor %}
    </table>

    <script>

    function sort(colIndex){
        const table = document.querySelector('table');
        const rows = Array.from(table.querySelectorAll('tr')).slice(1); // skip header
        let asc = this.dataset.asc === "true" ? false : true;
        this.dataset.asc = asc;

        rows.sort((a, b) => {
            const nameA = a.cells[colIndex].textContent.trim().toLowerCase();
            const nameB = b.cells[colIndex].textContent.trim().toLowerCase();
            if (nameA < nameB) return asc ? -1 : 1;
            if (nameA > nameB) return asc ? 1 : -1;
            return 0;
        });

        // Re-append sorted rows
        for (const row of rows) {
            table.appendChild(row);
        }
    }

    // Sort table by first name
    document.getElementById('sort-fname-btn').onclick = function() {
        sort.call(this, 1);
    };

    document.getElementById('sort-lname-btn').onclick = function() {
        sort.call(this, 2);
    };

    document.getElementById('sort-role-btn').onclick = function() {
        sort.call(this, 4);
    };
    </script>

    <!-- NAV BAR -->
    <button id="nav-toggle" class="nav-toggle">☰</button>
    <div id="navbar" class="navbar">
        <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li><a href="/profile">Profile</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
        {% if session.get('userinfo')['role']=='admin' 
        and session.get('userinfo')['status']=='approved' %}
        <ul class="nav-links">
            <h2 class="nav-header">ADMIN ZONE:</h2>
            <li><a href="/events">Events</a></li>
            <li><a href="/entries/pending">Pending Entries</a></li>
            <li class="current"><a href="/roster">Roster</a></li>
            <li><a href="/export">Export Data</a></li>
            <li><a href="/auditlog">Audit Log</a></li>
        </ul>
        {% endif %}
    </div>
    <script>
    document.getElementById('nav-toggle').onclick = function() {
        var navbar = document.getElementById('navbar');
        navbar.classList.toggle('collapsed');
        // Save state
        localStorage.setItem('navbarCollapsed', navbar.classList.contains('collapsed') ? '1' : '0');
    };
    window.addEventListener('DOMContentLoaded', function() {
        // auto-collapse
        var navbar = document.getElementById('navbar');
        navbar.classList.add('collapsed');
        localStorage.setItem('navbarCollapsed', '1');
    });
    </script>
    <!-- END OF NAV BAR -->
</body>

</html>