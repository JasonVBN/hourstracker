<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events</title>
    <link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/events.css">
    <link rel="stylesheet" href="/static/navbar.css">
    <style>
        .popup-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
        }
        .popup-bg.active {
            display: block;
        }
        .popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 32px 28px 24px 28px;
            z-index: 1001;
            min-width: 320px;
            max-width: 90vw;
            display: none;
        }
        .popup.active {
            display: block;
        }
        .popup-close {
            position: absolute;
            top: 12px;
            right: 18px;
            background: none;
            border: none;
            font-size: 1.3rem;
            color: #888;
            cursor: pointer;
        }

        .trash-btn {
            background: none;
            cursor: pointer;
            font-size: 1.2em;
            color: #999;
            transition: color 0.2s;
        }
        .trash-btn:hover {
            color: #f00000;
        }
        .help-icon:hover .help-tooltip,
        .help-icon:focus .help-tooltip {
            display: block;
        }
    </style>

    <!-- QRCode.js: -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- for trash icon: -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // Build eventsData as a JS object using Jinja2 inside a <script> tag
        var eventsData = {};
        {% for event in events %}
        eventsData["{{ event['id']|e }}"] = {
            name: {{ event['name']|e|tojson }},
            hours: {{ event['hours']|e|tojson }},
            date: {{ event['date']|e|tojson }},
            desc: {{ event['desc']|e|tojson }},
            proof: {{ 'true' if event.get('needproof') else 'false' }}
        };
        {% endfor %}
        function openPopup(eventId) {
            document.getElementById('popup-bg').classList.add('active');
            document.getElementById('popup').classList.add('active');
            // Prefill form fields
            var event = eventsData[eventId];
            if (event) {
                document.querySelector('#popup input[name="event_name"]').value = event.name || '';
                document.querySelector('#popup input[name="hours"]').value = event.hours || '';
                document.querySelector('#popup input[name="date"]').value = event.date || '';
                document.querySelector('#popup textarea[name="desc"]').value = event.desc || '';
                document.querySelector('#popup input[name="needproof"]').checked = !!event.proof;
            }
            // Set form action
            document.getElementById('edit-event-form').action = '/events/edit/' + eventId;
        }
        function closePopup() {
            document.getElementById('popup-bg').classList.remove('active');
            document.getElementById('popup').classList.remove('active');
            document.getElementById('popup2').classList.remove('active');
        }
        window.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.event-tile').forEach(function(tile) {
                tile.addEventListener('click', function() {
                    openPopup(this.dataset.eventId);
                });
            });
            document.getElementById('popup-bg').addEventListener('click', closePopup);
            document.getElementById('popup-close').addEventListener('click', closePopup);
            document.getElementById('popup2-close').addEventListener('click', closePopup);
        });

        function showqr(event, eventId) {
            if (event) event.stopPropagation();
            
            const url = "https://hourswizard.com/checkin/" + eventId;
            document.getElementById('qrcode').innerHTML = "";
            const qr = new QRCode(document.getElementById('qrcode'), {
                text: url,
                // correctLevel: QRCode.CorrectLevel.L
            });
            document.getElementById('qrlink').innerHTML = url;
            document.getElementById('popup-bg').classList.add('active');
            document.getElementById('popup2').classList.add('active');
        }

        function deleteEvent(clickevent, id){
            if (clickevent) clickevent.stopPropagation();
            if (confirm("U sure you wanna delete this event?")) {
                if (confirm("U *really* sure??? All hours associated with this event will go poof. This action is irreversible.")) {
                    fetch('/events/delete/' + id, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(response => {
                        if (response.ok) {
                            window.location.reload(); // Refresh the page to reflect changes
                        } else {
                            alert('Failed to delete event. Please try again later.');
                        }
                    })
                }
            }
        }
    </script>
</head>
<body>
    <div id="popup-bg" class="popup-bg"></div>
    <div id="popup" class="popup">
        <button id="popup-close" class="popup-close" type="button">&times;</button>
        <h2>Edit Event</h2>
        <form id="edit-event-form" method="post">
            <label>Name:
            <input type="text" name="event_name" placeholder="Event Name" required>
            </label>

            <label># of hours (leave blank or 0 for varying):
            <input type="number" name="hours" step="0.25" placeholder="hours">
            </label>

            <label>Date:
            <input type="date" name="date">
            </label>

            <label>Description: (optional)</label>
            <textarea name="desc" rows="2" placeholder="description"></textarea>
            
            <label>
            <input type="checkbox" name="needproof" value=1> Need proof
            </label>
            <button type="submit" class="btn">Save</button>
        </form>
    </div>

    <div id="popup2" class="popup">
        <button id="popup2-close" class="popup-close" type="button">&times;</button>
        <h2>Check-in:</h2>
        <div id="qrcode"></div>
        <strong><p id="qrlink"></p></strong>
    </div>

    <div class="container" style="max-width: 75%;">
        <h2>Events:</h2>
        {% if events %}
            <table style="width:100%; border-collapse:collapse;">
                <tr>
                    <th>Name</th>
                    <th>Date</th>
                    <th>Hours</th>
                    <th>Status</th>
                    <th>QR code</th>
                </tr>
                {% for ev in events %}
                <tr class="event-tile" data-event-id="{{ ev['id'] }}">
                    <td><strong>{{ ev['name'] }}</strong></td>
                    <td>{{ ev['date'] }}</td>
                    <td>{{ ev['hours'] if ev['hours'] else 'varying' }}</td>
                    <td>{{ 'active' if ev['active'] else 'inactive'}}</td>
                    <td>
                        <button class="getqr-btn" data-event-id="{{ ev['id'] }}" onclick="showqr(event, this.dataset.eventId)">Check-in QR code</button>
                    </td>
                    <td>
                        <i class="fas fa-trash trash-btn" onclick="deleteEvent(event, '{{ev['id']}}')" title="Delete"></i>
                    </td>
                </tr>
                {% endfor %}
            </table>
            [Click an event to edit]
        {% else %}
            <p>No events available.</p>
        {% endif %}
    </div>
        
    <form action="/events/new" method="post" hidden>
        <h2>Create new event:</h2>
        <label>Name:
        <input type="text" name="event_name" placeholder="Event Name" required>
        </label>

        <label>Unique code:
        <input type="text" name="code" placeholder="Event Code">
        <span class="help-icon" tabindex="0">?
            <span class="help-tooltip">
                <p>
                    Custom code for this event's check-in URL.<br>
                    Leave blank to have a random code generated automatically.
                </p>
            </span>
        </span>
        </label>

        <label># of hours (leave blank or 0 for varying):
        <input type="number" name="hours" step="0.25" placeholder="hours">
        </label>

        <label>Date:
        <input type="date" name="date">
        </label>

        <label>Description: (optional)</label>
        <textarea name="desc" rows="2" placeholder="description"></textarea>
        
        <label>
        <input type="checkbox" name="needproof" value=1> Need proof
        </label>

        <button type="submit">Create new event</button>
    </form>

    <!-- NAV BAR -->
    <div id="navbar" class="navbar">
        <button id="nav-toggle" class="nav-toggle">â˜°</button>
        <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li><a href="/profile">Profile</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
        {% if session.get('userinfo')['role']=='admin' 
        and session.get('userinfo')['status'] == 'approved' %}
        <ul class="nav-links">
            <h2 class="nav-header">ADMIN ZONE:</h2>
            <li class="current"><a href="/events">Events</a></li>
            <li><a href="/entries/pending">Pending Entries</a></li>
            <li><a href="/roster">Roster</a></li>
            <li><a href="/export">Export Data</a></li>
            <li><a href="/auditlog">Audit Log</a></li>
        </ul>
        {% endif %}
    </div>
    <script>
    document.getElementById('nav-toggle').onclick = function() {
        var navbar = document.getElementById('navbar');
        navbar.classList.toggle('collapsed');
        // Save state
        localStorage.setItem('navbarCollapsed', navbar.classList.contains('collapsed') ? '1' : '0');
    };
    window.addEventListener('DOMContentLoaded', function() {
        var navbar = document.getElementById('navbar');
        if (localStorage.getItem('navbarCollapsed') === '1') {
            navbar.classList.add('collapsed');
        } else {
            navbar.classList.remove('collapsed');
        }
    });
    </script>
    <!-- END OF NAV BAR -->
</body>
</html>