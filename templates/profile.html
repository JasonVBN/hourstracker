<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/navbar.css">
    <link rel="stylesheet" href="/static/slideswitch.css">

    <script>
    async function changePfp(input) {
        const file = input.files[0];
        if (!file) return;
        if (file.size > 4 * 1024 * 1024) { // 4 MB limit
            alert('File too large (max of 4MB)');
            return;
        }
        document.getElementById('pfp-spinner').style.display = 'inline-block';
        const response = await fetch('/profile/changepfp', {
            method: 'POST',
            body: new FormData(document.getElementById('pfp-form'))
        });
        document.getElementById('pfp-spinner').style.display = 'none';
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert('Failed: ' + data.msg);
        }
    }
    </script>
</head>
<body>
    <div class="container">
        <img src="{{session['userinfo'].get('pfp') or '/static/monkey1.png'}}" alt="pfp" style="display:block; max-height: 80px;">
        <form id="pfp-form" style="all:unset;">
        Change profile pic:
        <input type="file" id="pfp-upload" name="pfp-upload" accept="image/*" style="" onchange="changePfp(this)">
        <span id="pfp-spinner" style="display:none; vertical-align:middle;">
            <svg width="22" height="22" viewBox="0 0 50 50">
                <circle cx="25" cy="25" r="20" fill="none" stroke="#2563eb" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4">
                    <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.8s" repeatCount="indefinite"/>
                </circle>
            </svg>
        </span>
        </form>
        <!-- <button type="button" onclick="document.getElementById('pfp-upload').click();">Upload New Profile Pic</button> -->
    
        <p>Name: {{ session['userinfo'].get('fname') + ' ' + session['userinfo'].get('lname') }}</p>
        <p>Role: {{ session['userinfo'].get('role') }} <a href="/admin/request">[Change]</a></p>
        <p>Email: {{ session['userinfo'].get('email') }}</p>
        
        <label class="switch" id="notif-switch">
            <input type="checkbox" id="email-notify-toggle">
            <span class="slider"></span>
        </label>
        <span style="margin-left:12px;vertical-align:middle;">Email notifications</span>
        
        <p>Bio: <a href="#" id="edit-bio-link">[Edit]</a></p>
        <p id="bio-text">
            {{ session['userinfo']['bio']|replace('\n', '<br>')|safe }}</p>
        <form id="bio-form" action="/profile/editbio" method="post" style="all:unset; display:none;">
            <textarea name="bio" id="bio" rows="4" placeholder="Add your bio here">{{ session['userinfo'].get('bio') }}</textarea>
            <br>
            <button type="submit">Save</button>
        </form>
    </div>
    <script>
    document.getElementById('edit-bio-link').onclick = function(e) {
        e.preventDefault();
        document.getElementById('bio-text').style.display = 'none';
        document.getElementById('bio-form').style.display = 'block';
        this.style.display = 'none';
    };

    document.getElementById('email-notify-toggle').checked = {{ 'true' if session['userinfo'].get('notifs') else 'false' }};
    document.getElementById('email-notify-toggle').onchange = function() {
        const isChecked = this.checked;
        fetch('/profile/editnotif', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notify: isChecked })
        }).then(response => {
            if (!response.ok) {
                console.error('Failed to update notification preference');
            }
        }).catch(error => {
            console.error('Error:', error);
        }).then(
            () => {
                window.location.href = '/profile'; // Refresh the page to reflect changes
            }
        );
    };
    </script>

    <!-- NAV BAR -->
    <div id="navbar" class="navbar">
        <button id="nav-toggle" class="nav-toggle">â˜°</button>
        <ul class="nav-links">
            <li><a href="/">Home</a></li>
            <li class="current"><a href="/profile">Profile</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
        {% if session.get('userinfo')['role']=='admin' 
        and session.get('userinfo')['status']=='approved' %}
        <ul class="nav-links">
            <h2 class="nav-header">ADMIN ZONE:</h2>
            <li><a href="/events">Events</a></li>
            <li><a href="/entries/pending">Pending Entries</a></li>
            <li><a href="/roster">Roster</a></li>
            <li><a href="/export">Export Data</a></li>
            <li><a href="/auditlog">Audit Log</a></li>
        </ul>
        {% endif %}
    </div>
    <script>
    document.getElementById('nav-toggle').onclick = function() {
        var navbar = document.getElementById('navbar');
        navbar.classList.toggle('collapsed');
        // Save state
        localStorage.setItem('navbarCollapsed', navbar.classList.contains('collapsed') ? '1' : '0');
    };
    window.addEventListener('DOMContentLoaded', function() {
        var navbar = document.getElementById('navbar');
        if (localStorage.getItem('navbarCollapsed') === '1') {
            navbar.classList.add('collapsed');
        } else {
            navbar.classList.remove('collapsed');
        }
    });
    </script>
    <!-- END OF NAV BAR -->
</body>
</html>